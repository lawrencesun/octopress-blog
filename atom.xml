<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Lawrence Sun]]></title>
  <link href="http://voice.lawrencesun.info/atom.xml" rel="self"/>
  <link href="http://voice.lawrencesun.info/"/>
  <updated>2014-08-13T22:52:37+08:00</updated>
  <id>http://voice.lawrencesun.info/</id>
  <author>
    <name><![CDATA[Lawrence Sun]]></name>
    <email><![CDATA[yuliang1987@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails Notes: Remember Me and Reset Password]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/08/12/rails-notes-remember-me-and-reset-password/"/>
    <updated>2014-08-12T16:14:58+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/08/12/rails-notes-remember-me-and-reset-password</id>
    <content type="html"><![CDATA[<p><strong>1. Remember Me</strong></p>

<p>We used sessions to store user&rsquo;s id in order to let them sign in just once. However, when users close browser, the session cookie is deleted. So we would like to replace it with a permanent one. Besides, if we store and expose user&rsquo;s id, it could be dangerous.</p>

<p>Therefore, we will generate and store a unique token for each user. First, create a new column to store the token.</p>

<!-- more -->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails g migration add_remember_token_to_users remember_token:string
</span><span class='line'>$ rake db:migrate</span></code></pre></td></tr></table></div></figure>


<p>Then write a method to generate remember_token before creating a new user in models/user.rb</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">before_create</span> <span class="p">{</span> <span class="n">generate_token</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)}</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">def</span> <span class="nf">generate_token</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">[</span><span class="n">column</span><span class="o">]</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
</span><span class='line'>  <span class="k">end</span> <span class="k">while</span> <span class="no">User</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">column</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">[</span><span class="n">column</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add a checkbox in views/sessions/new.html.erb for user to let them choose if they want us to remember.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;checkbox&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;label&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= check_box_tag :remember_me, 1, params[:remember_me] %&gt;
</span><span class='line'>      <span class="err">&lt;</span>%= t(&#39;remember me&#39;) %&gt;
</span><span class='line'>  <span class="nt">&lt;/label&gt;&lt;br&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Modify the SessionsController so that we store remember_token in cookies when user signed in.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_username</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:remember_me</span><span class="o">]</span>
</span><span class='line'>          <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;flash.session.create.success&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_path</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;flash.session.create.error&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Modify the current_user method in application.rb so it reads the remember_token from cookies rather than the user.id from the session.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">current_user</span>
</span><span class='line'>  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we want to fill the remember_token column for existing users. Write a file called rebuild_remember_token.rake in lib/tasks and run <code>rake user:rebuild_remember_token</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:user</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Rebuild Remember-Tokens&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:rebuild_remember_token</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">User</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span>
</span><span class='line'>        <span class="n">u</span><span class="o">.</span><span class="n">update_attribute</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>2. Password Reset</strong></p>

<p>We would like to allow users to reset their password when they forget. First, we will generate the route: <code>resources :password_resets</code>.</p>

<p>Then add a link in the signin page(views/sessions/new.html.erb).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;checkbox&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="sx">%= check_box_tag :remember_me, 1, params[:remember_me] %&gt;</span>
</span><span class='line'><span class="sx">     &lt;%=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;.remember_me&#39;</span><span class="p">)</span> <span class="sx">%&gt; | &lt;%= link_to t(&#39;.forgotten_password&#39;), new_password_reset_path %&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sr">/label&gt;&lt;br/</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a password_resets_controller.rb file and a new.html.erb file in views/password_resets.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@user</span>
</span><span class='line'>          <span class="vi">@user</span><span class="o">.</span><span class="n">send_password_reset</span>
</span><span class='line'>          <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;flash.reset.email.success&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="n">root_path</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span>  <span class="n">t</span><span class="p">(</span><span class="s1">&#39;flash.reset.email.error&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;col-md-6 col-md-offset-3&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;well&quot;</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="n">h4</span><span class="o">&gt;&lt;</span><span class="sx">%= t(&#39;.password_reset&#39;) %&gt;&lt;/h4&gt;</span>
</span><span class='line'><span class="sx">         &lt;hr/&gt;</span>
</span><span class='line'><span class="sx">         &lt;%=</span> <span class="n">form_tag</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s1">&#39;post&#39;</span> <span class="k">do</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">         &lt;div class=&quot;form-group&quot;&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="sx">%= label_tag :email %&gt;&lt;br/&gt;</span>
</span><span class='line'><span class="sx">         &lt;%=</span> <span class="n">text_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">&quot;form-control&quot;</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">         &lt;/div&gt;</span>
</span><span class='line'>          <span class="o">&lt;%=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;.password_reset&#39;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">&quot;btn btn-primary&quot;</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">         &lt;% end %&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="sr">/div&gt;</span>
</span><span class='line'><span class="sr"> &lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we will add columns to store the a token for the reset request and the expire time of it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">migration</span> <span class="n">add_password_reset_to_users</span> <span class="n">password_reset_token</span><span class="ss">:string</span> <span class="n">password_reset_sent_at</span><span class="ss">:datetime</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the user is found by the email, we will generate a token and send a reset email using send_password_reset method in /models/user.rb</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">send_password_reset</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">update_column</span><span class="p">(</span><span class="ss">:password_reset_token</span><span class="p">,</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">update_column</span><span class="p">(</span><span class="ss">:password_reset_sent_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span class='line'>  <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the UserMailer and email template in /views/user_mailer/password_reset_text.erb</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">mailer</span> <span class="n">user_mailer</span> <span class="n">password_reset</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="ss">ActionMailer</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">&quot;from@example.com&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">&quot;Password Reset&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">To</span> <span class="n">reset</span> <span class="n">your</span> <span class="n">password</span> <span class="n">click</span> <span class="n">the</span> <span class="no">URL</span> <span class="n">below</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;%=</span> <span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_token</span><span class="p">)</span> <span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="no">If</span> <span class="n">you</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">request</span> <span class="n">your</span> <span class="n">password</span> <span class="n">to</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">please</span> <span class="n">ignore</span> <span class="n">this</span> <span class="n">email</span> <span class="ow">and</span> <span class="n">your</span> <span class="n">password</span> <span class="n">will</span> <span class="n">stay</span> <span class="n">as</span> <span class="n">it</span> <span class="n">is</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will need to alter enviroment configuration in /config/environment/development.rb to get URLs working. Similar line in production.rb with the live domain name.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Auth</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;localhost:3000&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The URL includes the token as the id parameter, which we will use it in edit action. Create a form for users to reset password in edit.html.erb</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'>  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_password_reset_token!</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h4</span><span class="o">&gt;&lt;</span><span class="sx">%= t(&#39;.password_reset&#39;) %&gt;&lt;/h4&gt;&lt;hr/&gt;</span>
</span><span class='line'><span class="sx">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error&#39;</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="vi">@user</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;%= form_for @user, url: password_reset_path(params[:id]) do |f| %&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;form-group&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="sx">%= f.label :password, t(&#39;password&#39;) %&gt;</span>
</span><span class='line'><span class="sx">     &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span><span class="s2">&quot;form-control&quot;</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">&quot;At least 6 digits&quot;</span><span class="sx">%&gt;</span>
</span><span class='line'><span class="sx"> &lt;/div&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;form-group&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="sx">%= f.label :password_confirmation, t(&#39;password_confirmation&#39;) %&gt;</span>
</span><span class='line'><span class="sx">     &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span><span class="s2">&quot;form-control&quot;</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx"> &lt;/div&gt;</span>
</span><span class='line'>  <span class="o">&lt;%=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">&quot;btn btn-primary&quot;</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;% end %&gt;</span>   
</span></code></pre></td></tr></table></div></figure>


<p>Here we use form_for in this form as we’re modifying a resource. Because of this we have to explicitly set the :url parameter so that the form isn’t POSTed to the UsersController. Instead it is sent to the PasswordResetsController’s update action, passing in the reset token as the id.</p>

<p>Finally, we will write the update action.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_password_reset_token!</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;flash.reset.error&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">new_password_reset_path</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">permit!</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:password_reset_token</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;flash.reset.success&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">signin_path</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><sub>Reference: <a href="http://railscasts.com/episodes/274-remember-me-reset-password?view=asciicast">Railscasts</a></sub></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Notes: How to 'Like' once and 'Unlike' in Rails]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/08/03/rails-notes-unlike-function/"/>
    <updated>2014-08-03T21:35:00+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/08/03/rails-notes-unlike-function</id>
    <content type="html"><![CDATA[<p>Few months ago, I added a <a href="http://voice.lawrencesun.info/posts/2014/02/11/rails-notes-adding-a-like-function/">&lsquo;Like&rsquo; function</a> to my rails project. It&rsquo;s a lovely function, but has some problems left. One is that users could like a single post/comment as much as they can, the other one is that users are not able to unlike.</p>

<p>Thus, I tried to improve the likeable function this weekend. First thing I came up with my head was to add a uniqueness validation.</p>

<!-- more -->


<p>Here is the code I added in <code>like.rb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validates_uniqueness_of</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">scope</span><span class="p">:</span> <span class="o">[</span><span class="ss">:likeable_id</span><span class="p">,</span> <span class="ss">:likeable_type</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>It worked. &lsquo;User&rsquo; could not cheat any more, well, up to a point. But if users want to their mind later on, they are not allowed to do so.</p>

<p>Regarding the second issue, I decided to handle it this way.</p>

<p>Let&rsquo;s assume there is a user called Mr.R. R liked a post, the params[:like] set to true. We would like to provide a link so that R could send another POST with the params[:like] = false. If R haven&rsquo;t make the choice or unliked it before, then a link to POST with the params[:like] = true is available.</p>

<p>First of all, I changed the like method in <code>posts_controller</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">like</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">post_liked</span>
</span><span class='line'>      <span class="vi">@like</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">like</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:like</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="no">Like</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">likeable</span><span class="p">:</span> <span class="vi">@post</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">like</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:like</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Like Updated!&quot;</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="ss">:back</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class='line'>  <span class="k">end</span>  
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">post_liked</span>
</span><span class='line'>  <span class="n">liked?</span><span class="p">(</span><span class="vi">@post</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, if R has already liked/unliked the post, and then changed his mind, we would update the <code>like</code> attribute rather than creating another data.</p>

<p>There are two methods in <code>application_controller</code>, which are available to views and posts/comments controllers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">liked?</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@like</span> <span class="o">=</span> <span class="no">Like</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">likeable</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">liked</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@like</span> <span class="o">=</span> <span class="no">Like</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">likeable</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@like</span>
</span><span class='line'>    <span class="k">return</span> <span class="vi">@like</span><span class="o">.</span><span class="n">like</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I adjusted <code>show.html.erb</code>in the view. As discussed before, I provided the oppsite like/unlike button to users&#8217; former dicision.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">span</span> <span class="nb">id</span><span class="o">=</span> <span class="s2">&quot;post_like&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;pull-right&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">% if </span><span class="n">signed_in?</span> <span class="o">&amp;&amp;</span> <span class="n">liked</span><span class="p">(</span><span class="vi">@post</span><span class="p">)</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">         &lt;%= link_to like_post_path(@post, like: false), method: &#39;post&#39;, remote: true do %&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="n">span</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;user_like_&lt;%= @post.id %&gt;&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;like&quot;</span><span class="o">&gt;&lt;</span><span class="n">i</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;fa fa-thumbs-o-up&quot;</span><span class="o">&gt;&lt;</span><span class="sr">/i&gt;&lt;/s</span><span class="n">pan</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="sx">% end %&gt; </span>
</span><span class='line'><span class="sx">     &lt;% else %&gt;</span>             
</span><span class='line'>      <span class="o">&lt;</span><span class="sx">%= link_to like_post_path(@post, like: true), method: &#39;post&#39;, remote: true do %&gt;</span>
</span><span class='line'><span class="sx">         &lt;span id=</span><span class="s2">&quot;user_like_&lt;%= @post.id %&gt;&quot;</span><span class="o">&gt;&lt;</span><span class="n">i</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;fa fa-thumbs-o-up&quot;</span><span class="o">&gt;&lt;</span><span class="sr">/i&gt;&lt;/s</span><span class="n">pan</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
</span><span class='line'><span class="sx">     &lt;% end %&gt;</span>
</span><span class='line'> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'> <span class="o">&lt;</span><span class="sr">/span&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Finally, I changed the <code>like.js.erb</code> file in order to present the difference between like and unlike, as well as the user&rsquo;s new dicision.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="n">liked</span><span class="p">(</span><span class="vi">@post</span><span class="p">)</span><span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">     $(&quot;#user_like_&lt;%= @post.id %&gt;</span><span class="s2">&quot;).addClass(&quot;</span><span class="n">like</span><span class="s2">&quot;);</span>
</span><span class='line'><span class="s2">&lt;% else %&gt;</span>
</span><span class='line'><span class="s2">     $(&quot;</span><span class="c1">#user_like_&lt;%= @post.id %&gt;&quot;).removeClass(&quot;like&quot;);</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">$(&quot;#post_like&quot;).load(&quot;&lt;%= @post.id %&gt;</span> <span class="c1">#post_like&quot;)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The comments like/unlike function is similar.</p>

<p>This improvement killed me a lot time this weekend, but thankfully, it worked at last. However, there must be a much easier &amp; clean way to do it.</p>

<p>By the way, I had updated my app to bootstrap 3.2, a more resposive-friendly version. It was an nightmare to change the style, like css class/id name etc. I also used fontawesome icons instead of the old ones. The app looks just fine.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby程序:自动抓取股票财务数据]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/07/18/stock-data-crawler/"/>
    <updated>2014-07-18T21:03:55+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/07/18/stock-data-crawler</id>
    <content type="html"><![CDATA[<p>无论是投资还是投机股市，股票的财务状况仍然是不可或缺的参考指标。传统金融网站上的数据往往以个股为单位呈现，导致数据的查询、对比和分析比较困难。如果要进行全局扫描和分析，可能就需要把这些数据一个一个下载后进行处理，这方面的时间成本略高。</p>

<p>前段时间在雪球偶然看到有人用Python做了一个自动获取数据的程序，觉得挺有趣，对大量数据的计算和分析可能有用，所以用了一天左右的时间用Ruby写了一个类似的代码。</p>

<!-- more -->


<p>数据来源于网易财经，理论上可以实现所有股票的任意财务数据的抓取，并导入csv文件。例如所有股票的”速动比率“（尽管不懂&hellip;），如下图所示。</p>

<p><img src="https://lh6.googleusercontent.com/-kE3w3S0vS_0/U8pK6OB_l0I/AAAAAAAAAsw/cAY1SvsE8mg/w400-h360-no/data.png" alt="img" /></p>

<p>核心代码如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 检测网页是否存在</span>
</span><span class='line'><span class="k">def</span> <span class="nf">valid_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>  <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>  <span class="n">req</span> <span class="o">=</span> <span class="ss">Net</span><span class="p">:</span><span class="ss">:HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</span><span class='line'>  <span class="n">res</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">request_head</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;200&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 抓取数据extract_data</span>
</span><span class='line'><span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">stock_num</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># 数据来源为网易股票频道，按报告期的主要财务指标，默认显示为6个季度</span>
</span><span class='line'>  <span class="n">source</span> <span class="o">=</span> <span class="ss">Nokogiri</span><span class="p">:</span><span class="ss">:HTML</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span><span class='line'>  <span class="c1"># 获取股票名称</span>
</span><span class='line'>  <span class="n">name_table</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;//h1[@class=&#39;name&#39;]//a&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="n">name_table</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">text</span>
</span><span class='line'>  <span class="c1"># 搜寻所有属于指定css class的值，返回的是一个Array</span>
</span><span class='line'>  <span class="n">data_table</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;//table[@class=&#39;table_bg001 border_box fund_analys&#39;]//td&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># 查找Array中含有指定文字描述的元素，并返回元素的地址</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 上一步查找到的元素地址后面的六个元素含有所需数据，将其中的数字部分提取出来</span>
</span><span class='line'>  <span class="c1"># 并加入到一个新建的Array中去</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 返回数据</span>
</span><span class='line'>  <span class="n">s</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>目前的主要问题是运行速度较慢，以后有时间看看能否改进。不管如何，在此数据的基础上做一些计算、对比和分析应该容易不少。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[如何合并多个Git commit]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/07/15/squash-git-commits/"/>
    <updated>2014-07-15T22:06:07+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/07/15/squash-git-commits</id>
    <content type="html"><![CDATA[<p>今天把之前做的一个rails项目升级到Twitter Bootstrap 3.2，结果问题一大堆。主要是class和id名称的改动，以及响应式布局的调整。最后在Heroku部署完成之后，发现原来的“点赞”图标无法正确显示，在stackoverflow翻阅了很多相关问答，和我有同样问题的人不少。但是按照这些方法去尝试，没有一个能有效解决。最终我改用了fonts awesome。</p>

<p>在这个期间，遇到了不少git方面的问题，看来之前还是没有把基础打好。</p>

<p>一个问题是由于不断尝试不同的方法，导致commit过多，非常混乱。于是想把多个commit合并到一起。具体方法如下：</p>

<!-- more -->


<p>首先<code>git log</code>查看目前的commit, 假设按照时间先后顺序有 a, b, c, d 三个commit.</p>

<p>现在要把四个合并到一起，使用<code>rebase</code>这个命令。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">git</span> <span class="n">rebase</span> <span class="o">-</span><span class="n">i</span> <span class="no">HEAD</span><span class="o">~</span><span class="mi">4</span>
</span><span class='line'>
</span><span class='line'><span class="n">pick</span> <span class="mo">01</span><span class="n">d1124</span> <span class="n">a</span>
</span><span class='line'><span class="n">pick</span> <span class="mi">6340</span><span class="n">aaa</span> <span class="n">b</span>
</span><span class='line'><span class="n">pick</span> <span class="n">ebfd367</span> <span class="n">c</span>
</span><span class='line'><span class="n">pick</span> <span class="mi">30</span><span class="n">e0ccb</span> <span class="n">d</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Rebase 60709da..30e0ccb onto 60709da</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Commands:</span>
</span><span class='line'><span class="c1">#  p, pick = use commit</span>
</span><span class='line'><span class="c1">#  e, edit = use commit, but stop for amending</span>
</span><span class='line'><span class="c1">#  s, squash = use commit, but meld into previous commit</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># If you remove a line here THAT COMMIT WILL BE LOST.</span>
</span><span class='line'><span class="c1"># However, if you remove everything, the rebase will be aborted.</span>
</span><span class='line'><span class="c1">#</span>
</span></code></pre></td></tr></table></div></figure>


<p>接着，把前四行进行如下替换：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">pick</span> <span class="mo">01</span><span class="n">d1124</span> <span class="n">a</span>
</span><span class='line'><span class="n">squash</span> <span class="mi">6340</span><span class="n">aaa</span> <span class="n">b</span>
</span><span class='line'><span class="n">squash</span> <span class="n">ebfd367</span> <span class="n">c</span>
</span><span class='line'><span class="n">squash</span> <span class="mi">30</span><span class="n">e0ccb</span> <span class="n">d</span>
</span></code></pre></td></tr></table></div></figure>


<p>Git将会把所有四个commit合并到第一个里面去。保存退出后，会出现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># This is a combination of 4 commits.</span>
</span><span class='line'><span class="c1"># The first commit&#39;s message is:</span>
</span><span class='line'><span class="n">a</span>
</span><span class='line'><span class="c1"># This is the 2nd commit message:</span>
</span><span class='line'><span class="n">b</span>
</span><span class='line'><span class="c1"># This is the 3rd commit message:</span>
</span><span class='line'><span class="n">c</span>
</span><span class='line'><span class="c1"># This is the 4th commit message:</span>
</span><span class='line'><span class="n">d</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>修改新的commit message后再次保存退出，合并完成。</p>

<p>如果在过程中出现冲突，可以使用<code>git rebase --abort</code>命令。</p>

<p>第二个问题是我在git push时候出现 &lsquo;Everything is up to date&#8217;。通过<code>git branch</code>查询发现当前的branch是* (no branch).</p>

<p>出现这种情况，首先<code>git reflog</code>， 找到最新的一个commit，然后创建一个临时branch.</p>

<p><code>git checkout -b temp-branch &lt;commit-id&gt;</code> 之后合并到master。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[曼游记终极篇之欧洲行 Day 5]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/07/11/travel-europe-day-5/"/>
    <updated>2014-07-11T21:00:46+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/07/11/travel-europe-day-5</id>
    <content type="html"><![CDATA[<p>昨晚查看了荷包，严重大出血，才玩了四天就把3/4的现金花完了，这是要流浪街头的节奏啊。接下来的旅程只有勒紧裤腰带了。</p>

<p>吃完早饭就先奔向位于佛罗伦萨东面的学院美术馆，又要参与一天一度的排队活动了。预定和不预定在这家馆差别不大，除非参加当地旅行社的skip the line. 好像英国很少有这种免排队的，可能是英国人都习惯并享受排队吧。</p>

<p>在排队途中看到美术馆外墙的各种涂鸦。有一句话很有意思: Stop planning. Get lost. Miss the train. And start the adventure. 的确如此，多年后回想以前的旅行，印象深刻的往往不是看过的风景，而是遇见的人和碰到的事，比如睡绿皮车，露宿广场，和陌生人一起吃饭看电影&hellip; 此次旅程至今短短几天，情况百出，注定会让人难忘。</p>

<!-- more -->


<p>队伍中有很多外国旅行者，美国人居多，而且美女不少，这几天排队下来，口音都被拐到美音上去了。日本人也很多，当然自然也少不了中国大妈团。</p>

<p>又跑题了，其实这次排队持续时间并不长，半小时不到。馆内主要陈列了各种油画和雕塑，还有不少古老的乐器。最著名的自然是米开朗基罗的大卫。这件可以真货，市政广场放的是假冒品。不得不说，这种珍品理应放在博物馆里，这样人们才能静静地欣赏。这尊雕塑真的是美轮美奂，比例匀称，线条流畅，每一个细节都是那么的完美。这是我继观赏苏格兰国立画廊的油画之后再次被艺术感动地要落泪。另外还看了制作等比例放大雕塑和木板刻画的视频。原来那些木板画的原料是颜料加蛋清，再贴上金箔。</p>

<p>出来后参观了据说是欧洲第四大天主教堂的圣百花大教堂。完全对称的设计，黑白大理石的外表，教堂内部倒是比较一般。教堂的穹顶和边上的钟楼都可以登顶，但是这种费时费力费钱的活，在这种热天气里可吃不消。</p>

<p>出了教堂，准备去中央广场，走了半天又回到学院美术馆门口，再次证明我强悍的GPS系统到了意大利就失效了。在中央广场买了牛肚堡，味道是不错，就是热天吃着有点腻。</p>

<p><img src="https://lh5.googleusercontent.com/-pJfKauNdgDY/Uv9qkvJNBOI/AAAAAAAAAbE/RnzPE2GLQXU/w400/h300" alt="img" /></p>

<p><sub>* 牛肚堡 </sub></p>

<p>来到火车站，结果去锡耶纳的火车取消了，就顺便去reserve明天前往威尼斯的火车票。坐慢车的话会损失不少时间，所以还是决定坐快速的。慢车的好处就是通票直接上车免费坐，但是会遇到延误或取消。快车则需要去购票处reserve，给售票员看通票，然后说要make a reservation.意大利高速铁路二等座需要补10欧元。从佛罗伦萨到威尼斯原价大约是46欧，所以还是便宜了一点。</p>

<p>原以为可以顺利去锡耶纳了，结果坐上车不久，所有人都下车了，似乎又要延误。我也跟着下车了，这时候不少人去了边上去比萨的车，结果我没弄明白就开走了，还有一部分去了边上前往利沃诺的车，我就听到边上乘务员说change, 时不我待，来不及详细询问，就在开车前几秒上了车。比较有把握的是，昨天去比萨途中路过恩波利，看到有去锡耶纳的车次。上车后看到了路线图就更坚信了这点，不过貌似这是趟快车，好在还没人查票。我甚至后悔昨天没去，搞不好这次意大利之行就要错过这个小镇了。到了恩波利，看到去锡耶纳的车，以为就此圆满。结果过了点还没开车，乘务员又跑出来说了一大堆鸟语，大家又纷纷下车。刚好我前面有人问去锡耶纳，回答说去2站台。一看，擦，就是刚才那趟从佛罗伦萨出来的车，整整晚点40多分钟。</p>

<p>在车上小憩，一个小时后终于抵达锡耶纳。一出车站就茫然了，空旷的一个广场，没什么人，也没有游客中心。走到对面，是一个大商场，有一家超市。这可是我最近几天第一次看到大超市，可乐只要99p，比佛罗伦萨便宜了1/3，果断入手一瓶。接着根据bus station的标志走，走了一段看到指向反方向的标志&hellip;回到超市门口，有一个自动扶梯，难道这就是传说中通往锡耶纳城的光明阶梯？这个扶梯连绵不绝，大约5分钟后看到出口。走出来是一条马路，什么标志也没有，周围几个也都是迷茫的游客。手机上下载的穷游和triposo地图太简略基本没用，想在自动货卖机买张地图，但是没有零钱。只好跟着其他几个游客瞎走了。走出百余米终于看到了指向市中心的指示牌，再走了一段看到了古老的城墙和城门。接着就是蜿蜒上坡的石板路。第一眼就喜欢上了这个相对远离喧嚣小镇。房屋没有佛罗伦萨的豪华，墙面多是裸露的红砖或是简单的涂层。继续向上来到田野广场，是欧洲现存最大的中世纪广场之一，这里是小镇的开阔地，也聚集了大量的游客，市政厅在此显得特别宏伟。尽管路标是鸟语而且指向不清，但还是找到了离此不远的教堂。这座教堂很有特点，结合了一些哥特风格。</p>

<p><img src="https://lh4.googleusercontent.com/-8AC1EuxchQY/Uv9qxYToWmI/AAAAAAAAAbg/QzU_mwCKO_M/w300/h400" alt="img" /></p>

<p><sub>* 锡耶纳的街道 </sub></p>

<p>从教堂出来想去地图上标志的另一个广场，结果我的自带导航系统再次出错，沿着一条小街走向了不归路，一直走出了城墙。有公交车站，看到路线图上有火车站的标志，然后觉得应该是下山方向，刚好车来就上了贼船。几分钟后发现不对，理应没这么远，似乎还看到了高速公路，又坐了几站，在一家超市前下了车。打开gps和triposo离线地图，我已经远离火车站，而且是在锡耶纳城外了。过马路看反向的车站，这是我才明白di 是从哪， al是去哪，只是站牌还是没显示这个车站是叫啥。焦急地等来了公车，重新回到原点。我沿着另一条路自动扶梯上山，才发现要去的广场来时已经路过了。下山途中，我又脑子短路，选择了一条和来时不同的路，由于有路标显示是去火车站，所以大胆往前走，结果这条路是汽车上山的大路，也就是说是盘山的远路，而且走着走着就没了标志。打开gps确信方向没错，继续走了20分钟，终于看到了火车站。刚好有要去佛罗伦萨的车，就上车了。</p>

<p>车上碰上一个在芬兰念书的阿叉，因为发现互相会说英文，所以就坐在一起聊天了。我曾经是多么讨厌阿叉英语啊，此时却觉得如此亲切。我们都在锡耶纳迷路，他说这个小镇像一个迷宫，还有各种迷惑的路标，他有地图也找不到方向。他和我反方向，从米兰来的，然后要去napoli和罗马。我们一起抱怨了意大利的热天气，我说我甚至怀念英国的雨了。说到佛罗伦萨的高物价，我说有的地方披萨卖20多磅，这个价钱都可以在英国吃three courses了。然后我们交流了一下旅行的经历。他问我喜欢独自自由行吗，我说喜欢，独行太有趣了。</p>

<p>回到佛罗伦萨已经8点多了，他说现在回这里感觉像是回家，第一天来时很困惑，第二天尽管还会迷路但是已经熟悉了。我说同感，而且刚才差点以为回不到这里了。互相问名字居然留到了分别前，只是我一秒钟后就忘了。</p>

<p>走出车站，找了一家餐馆吃了顿大餐来轻松一下，回到旅店倒头便睡。</p>

<p><img src="https://lh4.googleusercontent.com/-1eaimEt11Ww/Uv9qvldjQ-I/AAAAAAAAAbY/5IuKcyXppX0/w300/h400" alt="img" /></p>

<p><sub>* 边上坐着一对来自英国的老夫妻，看我拿着相机消毒，哈哈大笑 </sub></p>

<p><sub>20/06/2013 初稿于佛罗伦萨 06/2014 整理 </sub></p>

<p><sub>注: <a href="http://voice.lawrencesun.info/blog/categories/man-you-ji/">曼游记系列</a>: 本系列游记照片由谷哥四儿子联手谷哥相册友情提供，缺失部分关键照片，另外必要时需科学上网. </sub></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[I, Robot]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/07/10/i/"/>
    <updated>2014-07-10T21:01:30+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/07/10/i</id>
    <content type="html"><![CDATA[<p>由于众所周知的原因，网站常用的前端和字体库在国内的访问速度令人堪忧。今起这两部分改为国内CDN服务，同时关闭了某推的分享，经检测，页面载入暂时不再间歇性便秘了。至于图片，难产情况还是时有发生，暂时不处理了。</p>

<p>今天去柳阴蝉吟的西湖边，匆匆一瞥夏日的荷花。手机扫描照片后提示本人正身处曲院风荷，同时Google Now提醒高温，离家N公里。午后小憩，买一杯冰拿铁，手机随后推送来消费地点和账单。回家同步Fitbit，总共走了10,076步，勉强达到了目标。要是家里装有Philps hue bulbs的话，此时一定通过IFTTT设定，让灯光绚丽一番以示庆祝。</p>

<!-- more -->


<p>十年前可能无法想象科幻片般的情景。随着人工智能和可穿戴设备进一步发展，我们也许在不久的将来实现人的数字化和机器的拟人化。现在何处，将去哪里，晚上是否有约… 自动驾驶汽车将你安全送达酒吧，眼镜开始记录美好时光，手表提醒你此时的心跳有点加快… 所有的生理、心理状况都被数字化呈现并记录，同时经过分析后传回参考建议。</p>

<p>忽然发现，我们似乎离奇点越来越近。若干年后，随着原始技能的逐渐丧失，我们也许都将变成机器人。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[像马刺队一样打球]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/06/18/play-like-san-antonio-spurs/"/>
    <updated>2014-06-18T16:42:34+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/06/18/play-like-san-antonio-spurs</id>
    <content type="html"><![CDATA[<p>在刚刚结束的NBA总决赛中，圣安东尼奥马刺队4：1战胜了迈阿密热火，最后三场几乎是场场吊打，而拥有三巨头的热火毫无反抗之力。</p>

<p>难能可贵的是，他们在上赛季饮恨，当所有人都以为这支球队将就此没落之际，以前所未有的勇气和决心，王者归来。虽然谈不上是马刺队的球迷，但是当看到GDP组合抱在一起庆祝冠军的时刻，还是不禁为之动容。</p>

<p>这支有打发最华丽美誉的球队究竟有怎样的魔力，使得人们在一夜之间就为之倾倒？</p>

<!-- more -->


<p><em>团队篮球</em>：NBA球队大多数是球星战术，而马刺队则是全名皆兵，不管你是主力、替补，还是管饮水机、挥舞毛巾，只要在场上，就必须不断传球。老教练谆谆教导，老队员以身作则，球员之间互帮互助，团结信任。</p>

<p><em>稳定的核心</em>：石佛邓肯，这位表情帝仿佛幽灵一般，在这个联盟中屹立不倒。他与帕克、吉诺比利组成的三叉戟，成为了历史上胜场最多的组合。每个赛季结束都有人说，他们又老了一岁，结果他们又杀回来了。</p>

<p><em>伟大的教练</em>：波波维奇最伟大之处在于，把一只内线防守的球队，逐渐转化成高效进攻的球队，同时保持着阵容和战绩的稳定。很难想象的到，一位以严厉和固执著称的老头，居然是最会变通的教练。</p>

<p>尽管不是所有人都爱NBA，但是我想，每个人都希望能身处在如马刺队一样的团队里。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[曼游记终极篇之欧洲行 Day 4]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/04/19/travel-europe-day-4/"/>
    <updated>2014-04-19T19:21:38+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/04/19/travel-europe-day-4</id>
    <content type="html"><![CDATA[<p>起床后在旅舍吃了房东准备的简易早餐，便前往乌菲齐美术馆。途中路过市政广场，这里有不少雕像，包括著名的大卫(复制品)。尽管早就听闻乌菲奇很火爆，特地提早一点来，但还是来晚了，买票的队伍早已神龙见首不见尾了。如果有网上预定或者加入旅行团，就会省去排队的烦恼，当然这需要多花一点银子。</p>

<p>也许因为在最擅长排队的英国呆了多年，这种情况我也能从容面对，反正今天也不赶时间。在门口等了将近两个小时后，终于进入了这个古老的艺术殿堂。佛罗伦萨很多建筑都和美蒂奇家族有关，这个富有的家族简直就是土皇帝，赞助了大量的艺术家，可以说对文艺复兴的进程有着巨大的影响力。这家艺术馆就是美蒂奇家族曾经的办公室。</p>

<!-- more -->


<p><img src="https://lh4.googleusercontent.com/-07zymtmRnME/Uv9qcDX1eSI/AAAAAAAAAoo/NhTHFNJjQZE/w300/h400" alt="img" /></p>

<p><img src="https://lh3.googleusercontent.com/tdjLPpARFfKWXyqyhUsH8UXM-Q1om5_KXS6wGY6hn6M=w400-h300-no" alt="img" /></p>

<p><sub>* 市政广场 </sub></p>

<p>馆内以文艺复兴时期著名的画作和雕塑为主，包括很多大师如米开朗基罗、达芬奇等人的精品名作。中小学课本上出现的‘维纳斯出世’和‘春’的原画都在这里展出。这个时期的作品大多是宗教和神话题材，风格写实，构图和光线把人物刻画得栩栩如生，堪比如今电影院的3D。</p>

<p>佛罗伦萨不愧是文艺复兴的发祥地，随便进入一个馆就有大师作品。在英国时也去过不少美术馆，包括位于伦敦和爱丁堡的国家画廊，还有现代风格的泰特艺术馆。尽管收藏的名作很多，但是本土作者却很少，而且大多数艺术家都是在法国或者意大利接受熏陶的。如今各个艺术馆里也常看到一些外国艺术学生在老师的带领下参观和讨论。</p>

<p><img src="https://lh4.googleusercontent.com/-hRw5mmxPM-4/Uv9qakleS3I/AAAAAAAAAao/k9IDkW01Uz0/w400/h300" alt="img" /></p>

<p><sub>* 从乌菲齐美术馆看老桥 </sub></p>

<p>走出依河而立的美术馆，顶着午后的烈日，来到了旅店老板推荐的位于山腰的米开朗基罗广场。在这里可以一览佛罗伦萨全城美景。</p>

<p><img src="https://lh6.googleusercontent.com/-kugeUWGHNtU/U1Jwq-9YqkI/AAAAAAAAAo8/uAaNzdkIx_U/w400/h300" alt="img" /></p>

<p><img src="https://lh4.googleusercontent.com/-bf28pnIGNO0/U1JwsD9NTkI/AAAAAAAAApE/wehX6evIRy0/w300/h400" alt="img" /></p>

<p><sub>* 米开朗基罗广场看全城 </sub></p>

<p>下山时迷路了，好在方向正确，边走边找来到了皮蒂宫和花园。这个宫殿也属于美蒂奇家族，里面的展品也不少，但名作不多。宫殿本身十分宏伟，内部装饰极度奢华，粗略看来并不比白金汉宫差多少。至于后花园则平常无奇，英国随便一个庄园的就可以轻松完爆了。</p>

<p><img src="https://lh4.googleusercontent.com/-7LCWmtUrl-U/Uv9qQbAbP-I/AAAAAAAAAaY/EjYJSW7IUsY/w400/h300" alt="img" /></p>

<p><sub>* 皮蒂宫 </sub></p>

<p><img src="https://lh4.googleusercontent.com/-yLMQKq55ChU/U1JwpjCPpPI/AAAAAAAAAo0/XW2SYEpd_H0/w400/h300" alt="img" /></p>

<p><sub>* 老桥之上 </sub></p>

<p>之后沿着老桥回到市中心，这座桥历经多次洪水的洗礼，如今仍延续着繁华。接着走到同样被洪水侵袭多次的圣十字大教堂，这里葬着伽利略、米开朗基罗等多位大师，墙上的壁画和彩窗颇为精美。</p>

<p><img src="https://lh6.googleusercontent.com/-2V9EL6ywZds/U1JwyCajEcI/AAAAAAAAApU/mDVXDzE3CGc/w300/h400" alt="img" /></p>

<p><img src="https://lh4.googleusercontent.com/-cwG-pVJ6XtE/U1JwyEb9FKI/AAAAAAAAApQ/Qy5MfNX1ifc/w300/h400" alt="img" /></p>

<p><sub>* 圣十字大教堂 </sub></p>

<p>晚上吃了当地的特色牛排，味道也说不上出色，但是量特别大。还是配以啤酒，没办法，天太热。意大利的啤酒价格着实不便宜，差不多是英村的两倍。</p>

<p><img src="https://lh3.googleusercontent.com/-bLEzQ4i-7Q8/Uv9qf6Ms7aI/AAAAAAAAAa4/wsuIKBJPDFw/w300/h400" alt="img" /></p>

<p><img src="https://lh4.googleusercontent.com/-e4wK4VkjYrw/Uv9qkOVMHeI/AAAAAAAAAbI/gExZxBeNq7k/w300/h400" alt="img" /></p>

<p><sub>* 鹅肝酱和牛排 </sub></p>

<p>回旅店途中买了点牛奶，似乎意大利人不怎么爱牛奶，鲜奶的种类很少，价格也贵。另外奇怪的是，这里连锁超市几乎没有，取而代之的是各种坑爹的小店，还有不只是卖药的药店。佛罗伦萨路边的小铺特别多，主要经营皮包和纪念品，种类比较单一，有点像几个小铺在全城的复制黏贴。</p>

<p>另外这里的银行感觉特别少，难道他们都是靠黑帮洗钱的么。邮局的工作时间短得惊人，几个小时就关门了，典型的欧洲慵懒风。</p>

<p><sub>20/06/2013 初稿于佛罗伦萨 04/2014 整理 </sub></p>

<p><sub>注: <a href="http://voice.lawrencesun.info/blog/categories/man-you-ji/">曼游记系列</a>: 本系列游记照片由谷哥四儿子联手谷哥相册友情提供，缺失部分关键照片，另外必要时需科学上网，有高清无马需求的请联系我. </sub></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[闲谈比特币]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/03/22/my-view-on-bitcoin/"/>
    <updated>2014-03-22T10:48:31+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/03/22/my-view-on-bitcoin</id>
    <content type="html"><![CDATA[<p>一谈到比特币，似乎每个人都有自己的理解，有人认为是未来的货币，有人认为是又一个庞氏骗局。2013年对于比特币来说，是疯狂的一年，几十倍的增长，吸引了无数目光，甚至“中国大妈”也参与到其中。然而2014年以来，比特币风波不断，“门头沟”的倒闭，各路谣言的肆虐，近乎腰斩的价格，又使得不少人血本无归。</p>

<!-- more -->


<p><strong>接触比特币</strong></p>

<p>我大致是在2011年左右接触到比特币，当时已经是GPU时代，看到一些人在用电脑“挖矿”，觉得很有意思。当时并没有仔细研究比特币的原理，只是听说这个东西能赚钱，下载了客户端后加入了“矿池”。后来发现基本挖不出来什么，于是乎就放弃了。</p>

<p>2013年初，当时比特币腰斩到60多美元一个，李笑来发文章力挺。再后来，比特币就像脱缰的野马，一骑绝尘。</p>

<p>直到今年春节，参加了一个技术分享，才开始研究比特币，包括“中本聪”的论文和wiki。说实话，到现在，还没有搞得特别明白，但是被比特币背后所展示的技术深深吸引。</p>

<p>作为探索，我试着从一个地址送出比特币，可以说是秒传（当然还需要10分钟左右来确认）。这相对于目前的转账系统要快上N倍，不受地理限制，同时由于这笔交易记录在了全网账本上而无造假可能。</p>

<p>特点：</p>

<ul>
<li>去中心化: 发行和追踪都没有中央机构。</li>
<li>公开透明: 账本为全网共有。</li>
<li>交易安全: 数字签名，没有双重支付问题，全网认证，匿名。</li>
<li>储存安全: 可以&#8221;冷藏&#8221;只有你知道的密匙。</li>
</ul>


<p><img src="https://lh5.googleusercontent.com/-B9DCl06j--Y/Uy0cbaQ-dvI/AAAAAAAAAm8/eFox4v9LrOk/w400/h300" alt="img" /></p>

<p><sub> 壹比特杂志上关于比特币是如何交易的 <a href="http://img0.ph.126.net/x-_ST2r783x6tLbWe_q9vQ==/2971249854257795997.png">查看大图</a><sub></p>

<p><strong>比特币的发展</strong></p>

<p>相比传统的支付手段，用比特币支付可以节省手续费，没有地域限制。目前比特币的生态系统已初具规模，无论在线还是移动都可以使用钱包、银行、交易所、小额支付，而支持比特币支付的网站和商家也日益增多。</p>

<p>同时随着监管的加强和无良交易所的退出，非投机用户的增加，比特币的发展会逐步成熟稳定。</p>

<p><strong>比特币的投资</strong></p>

<p>历史上，比特币暴涨暴跌过多次，这也提供了不少投机的机会，间接促进了比特币的发展。但是对于大部分人来说，投机的风险非常高。一方面目前大多数在线交易所和钱包同时存在跑路和被黑客攻击的风险，另一方面由于无法监管、交易不可逆，很容易造成财产损失。同时比特币的涨跌不易预测，传统金融股市的一套几乎不管用。</p>

<p>所以对于一般人来讲，炒币盯盘不可取。要么别碰，要么就买币保有。</p>

<p><strong>比特币的未来</strong></p>

<p>也许会在未来成为一种主流的货币，也许会被比特币2.0代替，也许会一文不值… 但是比特币的技术必将不断发展，并广泛应用于各个领域。</p>

<p><sub> ps: 本人一个币也没有… 欢迎赞助: 1PaQWw1bqcQWDokPfCSiZTwc52RmDp42Vx；另外如果想通过实际比特币操作进一步了解的，可以留下地址，随机发送0.001 ~ 0.01mBTC&hellip;<sub></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[曼游记终极篇之欧洲行 Day 3]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/03/20/travel-europe-day-3/"/>
    <updated>2014-03-20T15:32:40+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/03/20/travel-europe-day-3</id>
    <content type="html"><![CDATA[<p>昨晚没有睡好。一早出门，在火车站喝了一杯espresso，坐上普通车，也就是慢车，北上佛罗伦萨——我在意大利的第二个根据地。慢车类似我们的绿皮车，好处就是拿着欧洲青年火车通票可以直接上车。行车速度还可以，就是每站必停，一路上弘扬雷锋精神礼让他车。</p>

<p>沿途隧道很多，唤起了小时候坐火车去闽南的回忆。在三个多小时的车程里，睡了两觉，看了1/4本书。佛罗伦萨地处意大利中部，因此火车站虽然不大，但很繁忙。出站之后就看到了对面的新圣母大殿，在边上的Tourist Information拿了份地图。</p>

<!-- more -->


<p><img src="https://lh4.googleusercontent.com/-7uV_V03Tcm0/Uv9oFWwnQUI/AAAAAAAAAWQ/kiQ7CGsMB8U/w400/h300" alt="img" /></p>

<p><sub>* 欧洲青年火车通票，10天无限次，上车后自己填好等查票 </sub></p>

<p>对照着地图和邮件里的信息，好不容易才找到了预定的旅舍。这家旅舍离火车站不远，边上有两条商业街，贩卖着旅游纪念品。由于旅舍位于居民楼里，我来回走了数次才发现门牌。这幢楼的大门非常高大，应该在3米以上。</p>

<p>刚好有人开门出来，我就走进去了，结果发现进去之后还有上锁的一扇铁门。于是我就困在了大门和铁门之间&hellip;门铃也没有&hellip;终于等到一位大哥出来了，会说一点英语，告诉我电梯上到三楼右转后再走楼梯就能看到。</p>

<p>旅舍老板很客气，寒暄了几句。这家旅舍是家庭经营的，主要由他负责，还有一位看起来怪怪的老奶奶负责卫生。我的房间在二楼，盘旋式的楼梯很窄，一次只能通行一个人。房间看起来挺破旧的，锁也简单的很，不过有一个淋浴间，卫生间是楼道公用的。这里房子一般有两层窗，一层普通的，一层百叶状的。</p>

<p>整理东西时才发现，一包东西落在火车上了，包括昨天刚买的短裤和洗漱装备。感觉这样发展下去，就要写血泪史了。</p>

<p><img src="https://lh5.googleusercontent.com/-nvME_8gvw5U/Uv9qCxyKTPI/AAAAAAAAAZw/obTduaBNx9E/w300/h400" alt="img" /></p>

<p><sub>* 到处都是披萨 </sub></p>

<p>下午吃了一块小披萨准备动身去比萨了。结果又忘带了通票，好在来回20欧不到。车慢得要死，一路晚点，在恩波利停留了将近40分钟，很多人都下车换后来居上的快车了。</p>

<p><img src="https://lh4.googleusercontent.com/-irF8LGrh6o4/Uv9qGXKjRrI/AAAAAAAAAaA/Kc6EAFoVuhY/w400/h300" alt="img" /></p>

<p><sub>* 被喷成花的火车 </sub></p>

<p>比萨城并不大，也没有什么特点，母亲河还没整治后的运河干净，来往行人并不多。但是在比萨斜塔，游客络绎不绝。斜塔至今已有八九百年历史，原来是个钟楼，由于地层不均造成倾斜。斜塔边上还有一个洗礼堂和一座大教堂。在沿街的商店里，匹诺曹的身影也出现在各种纪念品中。</p>

<p><img src="https://lh4.googleusercontent.com/-CoumGLaUVN4/Uv9qDnDWV9I/AAAAAAAAAZ4/rnb-n73jfJE/w300/h400" alt="img" /></p>

<p><sub>* 比萨斜塔 </sub></p>

<p>比萨斜塔固然是一个奇特的景观，在塔下摆各种pose的人民更是不可错过的风景。我偶遇了一对英国来的老夫妻，于是就让他们帮我拍了一张<code>托塔天王</code>。</p>

<p>两个多小时就结束了比萨小镇的游览，典型的到此一游。回程选择了快车，同样的价格，车速快了太多，还能享受空调。</p>

<p>回到住地休整，发现在意大利的烈日下呆上三天，就是<code>白斩鸡</code>也会变成<code>吴山烤鸡</code>。</p>

<p><sub>20/06/2013 初稿于佛罗伦萨 03/2014 整理 </sub></p>

<p><sub>注: <a href="http://voice.lawrencesun.info/blog/categories/man-you-ji/">曼游记系列</a>: 本系列游记照片由谷哥四儿子联手谷哥相册友情提供，缺失部分关键照片，本篇尤其严重，另外必要时需科学上网，有高清无马需求的请联系我. </sub></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[曼游记终极篇之欧洲行 Day 2]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/03/03/travel-europe-day-2/"/>
    <updated>2014-03-03T18:56:48+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/03/03/travel-europe-day-2</id>
    <content type="html"><![CDATA[<p>昨天忘了喷防晒，亡羊补牢，为时还是有点晚。防晒剂似乎过期变味了。。。没办法，英国一年也没几个晴天，基本没拿出来用过。下楼找了一家路边的酒吧，点了意大利标配，一杯Latte和一个牛角包。</p>

<p>其实这里不少人是直接喝espresso的，而且就站在吧台直接一口闷，有些人会再要杯tap water漱漱口。在英国几乎天天去starbucks, costa, nero这种烂大街的店喝。此番来意大利朝圣，发现这里咖啡的味道更加醇香，不知道是正宗口味还是心理作用。和其他地方不同，这里的咖啡店大多和酒吧是一同经营的，基本没有什么连锁店。</p>

<!-- more -->


<p><img src="https://lh6.googleusercontent.com/-b43icVP4qlA/Uv9pJ3nT9iI/AAAAAAAAAYI/ybx4hFHvL8Y/w300/h400" alt="img" /></p>

<p><sub>* Café Latte &amp; Croissant </sub></p>

<p>吃完早餐坐地铁来到了斗兽场。结果不幸碰到了工会集会，暂停开放。于是先去了边上的古罗马遗迹。由于语言不通，问了好几个人，跟着背包的路人，绕了几趟冤枉路才找到了入口。</p>

<p><img src="https://lh3.googleusercontent.com/-R95o0WfPP2M/Uv9pTr3F1GI/AAAAAAAAAYQ/zAAnFLntvQ4/w300/h400" alt="img" /></p>

<p><sub>* 古罗马遗迹 </sub></p>

<p>古罗马的宏伟会场、豪华宫殿，历经千年，如今只剩下残破不堪的墙体和兀自伫立的圆柱。但不难看出，当时的罗马帝国是多么的强盛。想象一下，站在巨大的神殿指点江山，该有多神气。遗址里有一处不太显眼的地方，还有人在此献花，原来是凯撒大帝被刺身亡的地方。</p>

<p><img src="https://lh5.googleusercontent.com/-gdKlcvEbjz8/Uv9pwLph20I/AAAAAAAAAZI/wXfOFbVesnw/w400/h300" alt="img" /></p>

<p><sub>* 古罗马元老院，神殿，祭堂 </sub></p>

<p>辗转回到了斗兽场，roma pass让我免去了排长队的困扰，一下子就超越了大队人马。圆形斗兽场非常壮观，当年的疯狂盛况一定不亚于如今英超赛场。这里的景象让人想起了刺客信条，我曾在此多次阵亡。。。恐怕当年角斗士们的困兽之斗也是九死一生。路人互助拍照片的时候还碰上了搞怪的三人组，忘了来自哪国的，拍得时候笑翻了。</p>

<p><img src="https://lh3.googleusercontent.com/-tsdW-y6bLKA/Uv9pi8l0-pI/AAAAAAAAAYs/u9ora8lzyOM/w300/h400" alt="img" /></p>

<p><sub>* 古罗马斗兽场 </sub></p>

<p>古罗马的神殿祭堂，拱门石墙，尽管已是断壁残垣，但考虑到这是两千多年的历史文物，仍然令人惊叹。此时不禁联想到天朝，蛮横的城市化建设破坏了多少珍贵的文化遗产。这些都是一去不复的，可笑的是，如今又想仿旧盖新。大城市的建筑已然失去了自身特点和文化传承，这无疑是对五千年文明的毁尸灭迹。小时候那种烧煤炉、跳皮筋的生活记忆也将随着老街道、瓦片房的坍塌一并消逝。</p>

<p><img src="https://lh5.googleusercontent.com/-Pleti5oS8nI/Uv9pjBLpjkI/AAAAAAAAAYw/puUwKTlToWQ/w400/h300" alt="img" /></p>

<p><sub>* 大爱这里的番茄 </sub></p>

<p>扯远了，走累了，遂路边小憩。喝啤酒，吃沙拉，晒太阳，然后一路向北。</p>

<p>参观了位于威尼斯广场的保守宫和新宫博物馆，以及边上的战争纪念馆，无一不大气磅礴。尽管这里馆藏丰富，雕塑、油画珍宝无数，还有阿基米德撬动地球的模型，但是审美疲劳加上旅途劳顿，基本是走马观花一扫而过。</p>

<p><img src="https://lh4.googleusercontent.com/-Wn4NoNtm82w/Uv9pmgpqVeI/AAAAAAAAAY4/gJIH_HNW4qQ/w400/h300" alt="img" /></p>

<p><sub>* 威尼斯广场 </sub></p>

<p>出来继续北上，来到了罗马市内最知名的喷泉，许愿池。这里聚集了大量的游客。不少人往清澈的池水里丢钱，据说可以许下三个愿望。我也拿出一欧元，作出背身扔币的动作，请人帮我拍了一张，然后。。。把钱放回口袋。。。</p>

<p><img src="https://lh4.googleusercontent.com/-sg-_UBhgcyo/Uv9pvf-_l4I/AAAAAAAAAZE/DvvMr668Heg/w300/h400" alt="img" /></p>

<p><sub>* 许愿池，在这里&#8221;投&#8221;了一个欧元 </sub></p>

<p>顺便说一句，意大利的水很贵，尤其是景点的小商小贩们，宰你没商量。不过意大利的街道边有很多泉水，不少人都去接水喝。</p>

<p>继续在迷路中前行。没办法，这里背街小巷没有整改，乱七八糟，加上坑爹的路标，除非全程GPS，否则走冤枉路是必修课。终于走到了西班牙广场，出名的原因是罗马假日里赫本坐在这里吃冰淇淋。广场的泉水旁此时正好有一个交响乐团在演奏。</p>

<p><img src="https://lh6.googleusercontent.com/-c6P2UmehNJA/Uv9py92rLUI/AAAAAAAAAZQ/CxkavSt4AhI/w300/h400" alt="img" /></p>

<p><img src="https://lh6.googleusercontent.com/-nqvOCdzzs2w/Uv9p8Q79y6I/AAAAAAAAAZo/IQI65P0TvKs/w300/h400" alt="img" /></p>

<p><sub>* 坐在西班牙广场的阶梯，听音乐、吃冰淇淋 </sub></p>

<p>从西班牙广场到人民广场的一路上，都是名牌店。正惊讶国内扫货团怎么不见踪影，仔细一看，原来是周日休息了。突然想到某本书上调侃的，不少人周日去教堂是因为没其他地方可去。附近找了一家店吃披萨，性价比超高，9欧元，又大又脆，两个人吃都够，只是服务一般，还想强收服务费，所以破例没给小费就走了。</p>

<p><img src="https://lh3.googleusercontent.com/-4V_2mfGbQ3E/Uv9p4Q2i4HI/AAAAAAAAAZY/DrfCGG_dCSc/w400/h300" alt="img" /></p>

<p><img src="https://lh6.googleusercontent.com/-VTYTFsvltOM/Uv9p6dNxQnI/AAAAAAAAAZg/pD7pwfMQltE/w300/h400" alt="img" /></p>

<p><sub>* 意大利著名食物，披萨和冰淇淋 </sub></p>

<p>之后还去看了共和广场。回旅舍中看到不少麦当劳的标志，相距十万八千里还标记，其实都指向了火车站那家。虽说防晒霜过期，但是搽和没搽区别很大。手臂上明显的三部分，被衣袖遮住的，涂过防晒的和裸奔的。裸奔的那块晒了一天发红了。好在我在这里并不算黑，不少人都晒得很健康。
感觉意大利的美女大多没有北欧的高又白，而是肤色健康，身形消瘦，头发略黑，眼睛深陷，加上一口听不懂的外语，别有风情。</p>

<p><sub>17/06/2013 初稿于罗马 03/2014 整理 </sub></p>

<p><sub>注: <a href="http://voice.lawrencesun.info/blog/categories/man-you-ji/">曼游记系列</a>: 本系列游记照片由谷哥四儿子联手谷哥相册友情提供，缺失部分关键照片，另外必要时需科学上网，有高清无马需求的请联系我. </sub></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Notes: Counter cache]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/03/01/rails-notes-counter-cache/"/>
    <updated>2014-03-01T10:18:40+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/03/01/rails-notes-counter-cache</id>
    <content type="html"><![CDATA[<p>By default, posts in my app are sorted by create_at time. I would like to sort them by the number of comments. In order to implement it, we will apply :counter_cache and :scope.</p>

<!-- more -->


<p>According to Active Record Association on Rails Guides, @post.comments.size requires making a call to the database to perform a COUNT(*) query. :counter_cache can be used to make finding the number of belonging objects more efficient.</p>

<p>First, run a migration to add the column called comments_count to posts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddCommentsCountToPosts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">:comments_count</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Post</span><span class="o">.</span><span class="n">reset_column_information</span>
</span><span class='line'>    <span class="no">Post</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">p</span><span class="o">.</span><span class="n">update_attribute</span> <span class="ss">:comments_count</span><span class="p">,</span> <span class="nb">p</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
</span><span class='line'>    <span class="n">remove_column</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">:comments_count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then add following code to <code>comment.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">belongs_to</span> <span class="ss">:post</span><span class="p">,</span> <span class="n">counter_cache</span><span class="p">:</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we will use scopes. According to Active Record Querying, scoping allows you to specify commonly-used queries which can be referenced as method calls on the association objects or models.</p>

<p>In our case, define a scope called active on <code>post.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">&quot;comments_count &gt;= ?&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then add routes to the <code>collection</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resources</span> <span class="ss">:posts</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">collection</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">get</span> <span class="s1">&#39;active&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>it will generate the path /posts/active with GET, route to the active action of PostsController, as well as active_posts_path route helper.</p>

<p>In PostsController, define <code>active</code> action</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">active</span>
</span><span class='line'>      <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;created_at DESC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;index&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, use @post.comments_count and active_posts_path in views to achieve what we want at the beginning.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Notes: Ajaxify Pagination]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/02/22/rails-notes-ajaxify-pagination/"/>
    <updated>2014-02-22T11:25:16+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/02/22/rails-notes-ajaxify-pagination</id>
    <content type="html"><![CDATA[<p>After applying <a href="http://voice.lawrencesun.info/posts/2014/02/16/rails-notes-pagination-with-kaminari/">pagination</a> in my app, I would like to ajaxify kaminari paginator. I googled and stackoverflowed this issue, and found the solution, which is quite similar to what I did in <a href="http://voice.lawrencesun.info/posts/2014/02/11/rails-notes-adding-a-like-function/">likeable</a> function.</p>

<!-- more -->


<p>First, add <code>remote: true</code> and class id to <code>index.html.erb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;posts&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">%= render &#39;shared/posts&#39;, object: @posts %&gt;</span>
</span><span class='line'><span class="sx">&lt;/div&gt;</span>
</span><span class='line'><span class="sx">&lt;div id=</span><span class="s2">&quot;paginator&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;%=</span> <span class="n">paginate</span> <span class="vi">@posts</span><span class="p">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Second, create a new file <code>index.js.erb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span><span class="p">(</span><span class="s2">&quot;#posts&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript render &#39;shared/posts&#39;, object: @posts %&gt;&quot;</span><span class="p">);</span>
</span><span class='line'><span class="err">$</span><span class="p">(</span><span class="s2">&quot;#paginator&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(paginate(@posts, remote: true).to_s) %&gt;&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Done.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[曼游记终极篇之欧洲行 Day 1]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/02/21/travel-europe-day-1/"/>
    <updated>2014-02-21T20:57:07+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/02/21/travel-europe-day-1</id>
    <content type="html"><![CDATA[<p>酒店叫醒和手机闹铃双炮齐响，我的欧洲之行正式开始了。胆战心惊地过了关，乘坐大巴车去登机。大巴开了很长时间，以至于边上有人说了句，Driving to Rome?</p>

<p>飞机一路南下，小憩片刻醒来，看到了疑似阿尔卑斯雪山和意大利的靴子海岸线。这里的农村和英村那种Wild的感觉不同，比较规矩，没什么绿色。到了机场，海关检查过程非常简单，就问了我居住在哪儿。还没曼城某些酒吧查证来得严。</p>

<p>出来坐火车去罗马市。正想显摆一下我的欧洲铁路通票，结果去市内直达线路是First Class。一等的座位，却是绿皮的速度，坐了半个多小时才到了罗马。我已经被车上各种看不懂的意大利文搞得有点晕，下来后好不容易找到Tourist Information，问了去旅舍的路，顺便买了Roma Pass (包含两个景点门票和三天的地铁通票)。</p>

<!-- more -->


<p>火车站很是破烂，我大天朝随便一个二三线城市的就可以完爆了。出来后更是一惊，穿梭的摩托车，乱贴的牛皮癣，拉游客的，躺地板的… 像是城乡结合部。住处离火车站不远，但是我尴尬地走进了身处同一幢楼的另一家青年旅舍…</p>

<p>把行李往地上一扔，就出门直奔梵蒂冈了。出地铁后跟着人群往前走，一段路之后便看到了梵蒂冈的高大围墙。之前看到说梵蒂冈博物馆要排很久，实际情况倒是没那么糟，预约与否也影响不大。</p>

<p>正当我要排队买票的时候，突然有个男的问我是不是要买票进去参观，我说是啊，心想是不是票贩子。结果他直接塞给我一张票，说他去不了了，也没问我要钱就转身走了。我嘴上说着谢谢，可是还没反应过来… 结果真的是有效票，考虑到昨天那个衰样，用人品守恒来解释并不为过。</p>

<p><img src="https://lh3.googleusercontent.com/-q_RrFajkmPk/Uv9oXiXxA6I/AAAAAAAAAWw/vv90NLIC7N4/w300/h400" alt="img" /></p>

<p><sub>* 梵蒂冈博物馆 </sub></p>

<p>博物馆内收藏了大量的雕塑和壁画，其中不少出自大师的手笔(说了我也不认识…)。可能是在英村看了太多的皇宫和庄园，新鲜感并不强。参观完毕后，沿着围墙来到了圣彼得大教堂。教堂前面的广场非常宏伟，四周是高大的圆柱。这里是欧洲最大的天主教堂之一，排队时间比较长。我对天主教倒是没什么好感，多次人为制造了教会至高无上的地位，假上帝之名奴役教众。当然除了这些，不能否认天主教对文化、建筑和艺术的深远影响。梵蒂冈不愧是大本营，无论是博物馆还是大教堂，无一不宏伟庄严、富丽堂皇，藏宝更是不计其数。</p>

<p><img src="https://lh6.googleusercontent.com/-u8MiE6DZ6Hk/Uv9oVm0ozSI/AAAAAAAAAWo/QqwVlfMQ2Yw/w400/h300" alt="img" /></p>

<p><img src="https://lh4.googleusercontent.com/-0qiOPWDWZPI/Uv9oZj4Og_I/AAAAAAAAAW4/d11AF79uRHk/w300/h200" alt="img" /></p>

<p><sub>* 梵蒂冈大教堂 </sub></p>

<p>沿着广场前进，路过了天使堡和罗马的母亲河。路边有很多小贩，卖各种假名牌包和旅游纪念品，然后不远处来了一队城管…</p>

<p><img src="https://lh5.googleusercontent.com/-fuj3VLfbBws/Uv9ojUWgpUI/AAAAAAAAAXE/_NT8tqT-Wvk/w400/h300" alt="img" /></p>

<p><sub>* 罗马天使堡 </sub></p>

<p>相比大教堂，我更喜欢居民小巷里的建筑。很多餐馆酒吧就开在路边，座位基本都是在户外，可能是这里常年晴朗，要是英村就不行了，还没晒几分钟就下雨了。不少人坐在那里，吃着意式美食，晒着太阳，听着艺人的手风琴，非常惬意。</p>

<p><img src="https://lh6.googleusercontent.com/-VbZlc_Q7sqc/Uv9oj7crv_I/AAAAAAAAAXM/N8Aai1GbjVM/w300/h400" alt="img" /></p>

<p><sub>* 罗马街头巷尾 </sub></p>

<p>走出小巷，来到纳沃纳广场。周围一圈房子都是巴洛克风格的，非常漂亮。广场中间有三个喷泉，海神喷泉、四河喷泉和摩尔喷泉。这里有很多民间艺人在这里展现自己。本想在边上的餐馆坐下来，可是一道主菜就要20欧，于是就先去了不远处的万神殿。这可是罗马帝国时期的建筑，室内非常宽广，四周是壁龛，由大穹顶的一个圆洞提供光源。</p>

<p><img src="https://lh5.googleusercontent.com/-YW9kdKHBjRw/Uv9okIKV7cI/AAAAAAAAAXQ/nNLrqHniD2o/w400/h300" alt="img" /></p>

<p><img src="https://lh3.googleusercontent.com/-9cPDZimvnwA/Uv9o8mddCnI/AAAAAAAAAXo/jcpcahYC0aQ/w400/h300" alt="img" /></p>

<p><sub>* 罗马纳沃纳广场 </sub></p>

<p><img src="https://lh4.googleusercontent.com/-9W3r9kCbX9k/Uv9o4LLM64I/AAAAAAAAAXg/ZuvWDmNqeCM/w400/h300" alt="img" /></p>

<p><sub>* 罗马万神殿 </sub></p>

<p>出来后在一家小店坐下，吃了意粉和沙拉，当然还少不了一杯啤酒。吃饱喝足后，夜色已然降临，坐公交车准备回旅舍。车上很挤，而我的挤车能力已经渣了。和曼城直接拿钱问司机买票不同，这个车上只有一个刷卡机，貌似是自觉刷卡，没有人查。 我不知道刷什么卡，于是疑似逃票了… 和曼城的公交一样，没有英文报站，坐到哪里全靠感觉… 这点我大杭州的公交就太有人文关怀、国际视野了，每站必停，而且不少线路是双语报站。只是老外就算想坐公交，恐怕挤上的概率也不大。</p>

<p><img src="https://lh5.googleusercontent.com/-CXFq7nhNkIs/Uv9pBjYH64I/AAAAAAAAAX8/FKpSnhkG_qk/w300/h400" alt="img" /></p>

<p><img src="https://lh4.googleusercontent.com/-VkTm9GbIAJQ/Uv9pBSA75YI/AAAAAAAAAX0/I2NwWRxCtS4/w300/h400" alt="img" /></p>

<p><sub>* 在意大利的第一餐 </sub></p>

<p>洗完澡后在附近转了一圈，发现火车站周围有不少酒吧很火爆，而且价格公道，今天为了赶路就吃了一顿饭，明天有机会在这里找一家试试。这里美式快餐店难寻，可以看出意大利人对自己的美食还是情有独钟。</p>

<p><img src="https://lh6.googleusercontent.com/-T845u2BoCL8/Uv9pCND2iLI/AAAAAAAAAYA/BdKCiTnh574/w300/h400" alt="img" /></p>

<p><sub>* 罗马夜色下的&#8221;大排档&#8221; </sub></p>

<p>吃饭时写了一点笔记，躺在旅舍完成了初稿，由于床上是一个来自英村的美女，哦，是床的上铺… 记录时有些分心。抬头一看，突然发现有张写着Wifi用户名和密码的纸条塞在上铺的床底木板中间… 今天是普度众生日吗…</p>

<p><sub>16/06/2013 罗马初稿 02/2014 整理 </sub></p>

<p><sub>注: 本系列游记照片由谷哥四儿子联手谷哥相册友情提供，缺失部分关键照片，另外必要时需科学上网，有高清无马需求的请联系我.</sub></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Notes: Pagination with Kaminari]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/02/16/rails-notes-pagination-with-kaminari/"/>
    <updated>2014-02-16T22:13:47+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/02/16/rails-notes-pagination-with-kaminari</id>
    <content type="html"><![CDATA[<p>With hundreds and thousands of posts on website, we would like to insert some breaks. The first choice for pagination in Rails is will_paginate. However, I find a better one called <a href="https://github.com/amatsuda/kaminari">Kaminari</a>.</p>

<!-- more -->


<p><strong>Controllers and Views</strong></p>

<p>First, add &lsquo;kaminari&rsquo; to &lsquo;Gemfile&rsquo; and run <code>bundle install</code></p>

<p>Second, we apply the scope called <code>page</code> and <code>per</code> in our Controller.</p>

<p><code>@posts = Post.all.page(params[:page]).per(15)</code></p>

<p>that will show 15 posts per each page.</p>

<p>Then, we call <code>paginate</code> helper in our views.</p>

<p><code>&lt;%= paginate @posts %&gt;</code></p>

<p><strong>Configure the default value</strong></p>

<p>run <code>rails g kaminari:config</code> and change the file <code>kaminari_config.rb</code> in config/initializers</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Kaminari</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">default_per_page</span> <span class="o">=</span> <span class="mi">15</span>
</span><span class='line'>  <span class="c1"># config.max_per_page = nil</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">outer_window</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="c1"># config.left = 0</span>
</span><span class='line'>  <span class="c1"># config.right = 0</span>
</span><span class='line'>  <span class="c1"># config.page_method_name = :page</span>
</span><span class='line'>  <span class="c1"># config.param_name = :page</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>I18N and labels</strong></p>

<p>We can change the default labels in config/locales.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">en</span><span class="p">:</span>
</span><span class='line'>  <span class="ss">views</span><span class="p">:</span>
</span><span class='line'>    <span class="ss">pagination</span><span class="p">:</span>
</span><span class='line'>      <span class="ss">first</span><span class="p">:</span> <span class="s2">&quot;&amp;laquo; First&quot;</span>
</span><span class='line'>      <span class="ss">last</span><span class="p">:</span> <span class="s2">&quot;Last &amp;raquo;&quot;</span>
</span><span class='line'>      <span class="ss">previous</span><span class="p">:</span> <span class="s2">&quot;&amp;lsaquo; Prev&quot;</span>
</span><span class='line'>      <span class="k">next</span><span class="p">:</span> <span class="s2">&quot;Next &amp;rsaquo;&quot;</span>
</span><span class='line'>      <span class="ss">truncate</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Configure the default view</strong></p>

<p>run <code>rails g kaminari:views default</code> and change the files in app/views/kaminari</p>

<p>e.g. I delete the first and last label in _pagination.html.erb and change the style to bootstrap according to the theme provided by the Kaminari.</p>

<p><strong>Issue</strong></p>

<p>I followed the instruction on Railscasts and the wiki of Kaminari. But my case seemed more complicated. I set three posts per page as default for test, but found that the posts presented in a strange array.</p>

<p>PostsController:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>index.html.erb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= render &#39;shared/posts&#39; , object: @posts%&gt;</span>
</span><span class='line'><span class="sx">&lt;%=</span> <span class="n">paginate</span> <span class="vi">@posts</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>_posts.html.erb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% object.reverse.each </span><span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem was that 3 posts each time was passed into the partial and was implemented the reverse scope. So I deleted the <code>reverse</code> scope and changed the line in the controller like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@posts</span> <span class="o">=</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;created_at DESC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Notes: Add Administrator]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/02/15/rails-notes-add-administrator/"/>
    <updated>2014-02-15T16:02:33+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/02/15/rails-notes-add-administrator</id>
    <content type="html"><![CDATA[<p>On the land of website/software, there is always an Administrator. The Administrator, like a king, has the right to change the rules, block the news and &lsquo;kill&rsquo; the innocent users whenever he likes.</p>

<blockquote><p>Dieu et mon droit.</p></blockquote>

<p>Today, I claimed to the throne &mdash; became an admin who had the power to delete comments and users.</p>

<!-- more -->


<p>First, <code>rails g migration add_admin_to_users</code>.</p>

<p>Second, create a table and run <code>rake db:migrate</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>      <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, define a method in ApplicationController.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">admin_user</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>   <span class="c1"># line_to_be_modified </span>
</span><span class='line'>    <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Please contact admin.&quot;</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, add <code>destroy</code> to UsersController</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">before_action</span> <span class="ss">:admin_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>  <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
</span><span class='line'>  <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;User deleted.&quot;</span>
</span><span class='line'>  <span class="n">redirect_to</span> <span class="n">users_path</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Afterwards, add a delete link in the view.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">method</span><span class="p">:</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s1">&#39;You sure?&#39;</span><span class="p">}</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we would like to destroy the posts and comments automatically at the same time we delete the users. <code>has_many :posts, dependent: :destroy</code></p>

<hr />

<ul>
<li>Issue 1:
There would be a nil class error if there was no user signed in, <code>current_user.admin?</code> went wrong. Therefore, I added another method in ApplicationController and change the line_to_be_modified to <code>unless admin?</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">admin?</span>
</span><span class='line'>  <span class="n">signed_in?</span> <span class="o">&amp;&amp;</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Issue 2:
Another error occurred when I tried to add the delete link on the comments partial.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="n">object</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">any?</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx"> &lt;% object.comments.each do |comment| %&gt;</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">% if </span><span class="n">admin?</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">     &lt;%= link_to &#39;delete&#39;, post_comment_path($params), method: &#39;delete&#39;, data: { confirm: &#39;You sure?&#39;} %&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>At first, I passed in the &lsquo;comment&rsquo; as $params, and it showed that  the post.id and :id were nil. So I changed the $params to &lsquo;comment.post.id, comment.id&rsquo; and it went well.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[曼游记终极篇之欧洲行 Day 0]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/02/14/travel-europe-day-0/"/>
    <updated>2014-02-14T22:02:25+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/02/14/travel-europe-day-0</id>
    <content type="html"><![CDATA[<p>拖了大半年，终于决定开始动笔。让我如此肆无忌惮的原因是当时在旅途之中，用Evernote记录了一些笔记。可是再拖下去，恐怕这些碎片将无法勾勒出那次奇妙的旅行。</p>

<p>曼游记里有太多值得回忆的瞬间，其中最High的应该就是2013年暑假历时半个月的欧洲自由行了。这是曼游记第一次也是最后一次踏出小不列颠，向欧洲大陆进发。</p>

<p>欧洲申根签证的过程颇具戏剧性，可以参考之前的<a href="http://lawrencesun.info/blog/?p=890">一篇</a>，这里不做累述。</p>

<p>我的<code>诺曼底登陆</code>选在了罗马，但是出师不利。一晚兴奋得没有睡，然后背着行囊，在酒鬼和流浪汉的上班时间，独行夜路，来到火车站。不料火车晚点了半个多小时。赶到机场后，手贱又买了本书，&#8217;An idiot abroad 2&#8217;, 这直接导致我的kindle在后续旅途中沉在包底独自悲伤。</p>

<p>当然更加悲伤的是我，真的成了idiot，&#8217;An idiot failed to board 1&#8217;: 我在准备登机的时候被拦下，原因是作为非欧盟区的居民，登机牌必须要有旅行文件的审核章，这是需要在安检之前完成的。因为之前选择了网上登机，而且没有看清文件的要求，只得眼睁睁地看着飞机起飞，然后被机场人员&#8217;押送&#8217;至英村边境口…</p>

<!-- more -->


<p>边境官员姗姗来迟，还一本正经地问了一堆问题。于是我完成了史上最迅速的出入境。机场人员倒是很热心，安慰我一番后提供了第二天航班的信息。我用电量不足的手机定了另一个航空公司的班次（我的钱包啊…），好在抵达时间比较早，落地机场也离罗马比较近。</p>

<p><img src="https://lh3.googleusercontent.com/-nLsQSHOKnZs/Uv9oKWyOMaI/AAAAAAAAAWg/du6stzgwvqw/w300/h400" alt="img" /></p>

<p><sub>* 凌晨在火车站焦急等待晚点的火车</sub></p>

<p>实在不想在凌晨重走夜路，想想既然是度假，那就花点血本吧，一咬牙在机场的四星级酒店订了一晚，真是出师未捷先卖血。</p>

<p><img src="https://lh5.googleusercontent.com/-8QLS7f3NbG0/Uv9oFenAqXI/AAAAAAAAAmY/Lu7zbx8Se2U/w400/h300" alt="img" /></p>

<p><sub>* 辛苦大半年换来的英镑变成了欧元，数量多了点，略感欣慰…</sub></p>

<p>放下包裹，顺道去了下附近的Regus，用之前一天刚拿到的金卡在里面吃了点免费的点心茶水，玩了下iMac，让服务人员打印了新的登机牌。发邮件给罗马的青年旅舍，动情地描述了我的悲惨经历，客服MM十分感动，然后…帮我保留了后面两天的预定，并说如果我的床位卖出去了就不收第一晚的钱了。</p>

<p>由于机场附近实在没啥好玩的，又乘火车回市里溜达了一圈，买了三文治和饮料作晚餐，然后回酒店补觉。</p>

<p><img src="https://lh6.googleusercontent.com/-zmOg3ZHclzk/Uv9oFV1tp3I/AAAAAAAAAmc/UFOT99xF6Mc/w300/h400" alt="img" /></p>

<p><sub>* 签证时提交的最初计划，结果第一天来了个本地机场一日游…</sub></p>

<p><sub>注: 本系列游记照片由谷哥四儿子联手谷哥相册友情提供，缺失部分关键照片，另外必要时需科学上网，有高清无马需求的请联系我.</sub></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Notes: Markdown Support]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/02/14/rails-notes-markdown-support/"/>
    <updated>2014-02-14T12:40:02+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/02/14/rails-notes-markdown-support</id>
    <content type="html"><![CDATA[<p>The default output of the content in my app is directly shown as HTML. The problem is even I entered several paragraphs, it will be shown in one. On the other hand, I intend to add markdown support in the beginning. Thanks Google and Github, I found a gem called <a href="https://github.com/vmg/redcarpet">Redcarpet</a>.</p>

<p>First I found a screencast in <a href="1">Railscasts</a>. Unfortunately, this solution was introduced 2 years ago. However, I found an up-to-date one by SimplizIT below the video. Here it is.</p>

<!-- more -->


<ul>
<li><p>Install it by adding <code>gem 'redcarpet'</code> to Gemfile, and run <code>bundle install</code>.</p></li>
<li><p>Then add the following code to <code>application_helper.rb</code></p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">markdown</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>  <span class="n">renderOptions</span> <span class="o">=</span> <span class="p">{</span><span class="n">hard_wrap</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="n">filter_html</span><span class="p">:</span> <span class="kp">true</span><span class="p">}</span>
</span><span class='line'>  <span class="n">markdownOptions</span> <span class="o">=</span> <span class="p">{</span><span class="ss">autolink</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="n">fenced_code_blocks</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="n">no_intra_emphasis</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">strikethrough</span><span class="p">:</span> <span class="kp">true</span><span class="p">}</span>
</span><span class='line'>  <span class="n">markdown</span> <span class="o">=</span> <span class="ss">Redcarpet</span><span class="p">:</span><span class="ss">:Markdown</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">Redcarpet</span><span class="p">:</span><span class="ss">:Render</span><span class="o">::</span><span class="no">HTML</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">renderOptions</span><span class="p">),</span> <span class="n">markdownOptions</span><span class="p">)</span>
</span><span class='line'>  <span class="n">markdown</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">html_safe</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><sub>here, we can customise the markdown extension and html output by changing the renderOptions and markdownOptions. The full option shows <a href="1">here</a>.</sub></p>

<ul>
<li>Apply &lsquo;markdown&rsquo; function in the view template.</li>
</ul>


<p><code>&lt;%= markdown(@post.text) %&gt;</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Notes: Adding a 'Like' Function]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/02/11/rails-notes-adding-a-like-function/"/>
    <updated>2014-02-11T21:16:52+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/02/11/rails-notes-adding-a-like-function</id>
    <content type="html"><![CDATA[<p>Instead of text comments, we can easily state our opinion on the article by clicking a &lsquo;Like&rsquo; button or a &lsquo;Vote&rsquo; arrow. It is not uncommon that this function plays a role of recommendation. Last week, I added a similar function called &lsquo;Likeable&rsquo; to my blog-like app. Here is the key notes.</p>

<!-- more -->


<p><strong>Migration and Models</strong></p>

<p>First of all, we <code>rails g migration create_likes</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateLikes</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:likes</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">boolean</span> <span class="ss">:like</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:likeable</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>      <span class="n">drop_table</span> <span class="ss">:likes</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, like boolean will show the choice of like(true) or unlike(false), :user_id will show who made the choice.</p>

<p><code>t.references :likeable, polymorphic: true</code> will generate two columns: <em>likeable_id</em> and <em>likeable_type</em> (e.g. Post or Comment).</p>

<p>With <em>Polymorphic</em> association, a model can belong to more than one other model, on a single association <a href="http://guides.rubyonrails.org/association_basics.html#polymorphic-associations">[1]</a>. In our case, like model can belong to post model or comment model.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Like</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:likeable</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:likes</span><span class="p">,</span> <span class="n">as</span> <span class="ss">:likeable</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:likes</span><span class="p">,</span> <span class="n">as</span> <span class="ss">:likeable</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Routes</strong></p>

<p>We would like to use a member routes here.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resources</span> <span class="ss">:posts</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">member</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">post</span> <span class="s1">&#39;like&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="n">resources</span> <span class="ss">:comments</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">member</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">post</span> <span class="s1">&#39;like&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It will recognise &lsquo;/post/post_id/like&rsquo; and &lsquo;/post/post_id/comment/id/like&rsquo; with POST, route to the action of PostsController and CommentsController, create the like_post_path and like_post_comment_path helpers.</p>

<p><strong>Views</strong></p>

<p>&lsquo;app/views/posts/show.html.erb&rsquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;pull-right&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">%= link_to like_post_path(@post, like: true), method: &#39;post&#39; do %&gt;</span>
</span><span class='line'><span class="sx">  &lt;i class=</span><span class="s2">&quot;icon-thumbs-up&quot;</span><span class="o">&gt;&lt;</span><span class="sr">/i&gt;</span>
</span><span class='line'><span class="sr"> &lt;%= @post.likes.size %&gt;likes %&gt;</span>
</span><span class='line'><span class="sr"> &lt;% end %&gt;</span>
</span><span class='line'><span class="sr">&lt;/s</span><span class="n">pan</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we specify the method POST instead of the default a_tag method GET, by adding <code>method: 'post'</code>. This will add &lsquo;data_method=&ldquo;post&rdquo;&rsquo; to link tag, which will revoke a javascript in rails that convert the link tag to a form and submit it. We also pass in a params &lsquo;like&rsquo; to be true, which means it will count as a &lsquo;Like&rsquo;.</p>

<p>Now we need some actions.</p>

<p><strong>Action</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:find_post</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span><span class="o">[</span><span class="err">…</span><span class="p">,</span> <span class="ss">:like</span><span class="o">]</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:require_user</span><span class="p">,</span> <span class="ss">except</span><span class="p">:</span><span class="o">[</span><span class="err">…</span><span class="o">]</span>
</span><span class='line'>  <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">like</span>
</span><span class='line'>      <span class="no">Like</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">likeable</span><span class="p">:</span> <span class="vi">@post</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">like</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:like</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Like Counted!&quot;</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="ss">:back</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we will pass params of @post to likeable_id and likeable_type, current_user &rsquo;s id and set &lsquo;true&rsquo; on like boolean.</p>

<p><strong>Ajax</strong></p>

<p>Every time we hit the &lsquo;Thumbs-up&rsquo; button, it will hit the datebase and rebuild the whole page. It&rsquo;s quite expensive. So we will use another rails magic here.</p>

<p>Simply add <code>remote: true</code>: &lsquo;&lt;%= link_to like_post_path(@post, like: true), method: &#8216;post&rsquo;, remote: true do %>&lsquo;. It will become a ajax request when we hit the &#8216;Thumbs-up&rsquo;.</p>

<p>In the meantime, we add response to this request in controller, revise our show.html.erb and add a <code>like.js.erb</code> view template file in app/views/posts, respectively.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">like</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Like Counted!&quot;</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="ss">:back</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class='line'>  <span class="k">end</span>          
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">span</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;post_&lt;%= @post.id %&gt;_likes&quot;</span><span class="o">&gt;&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">size</span> <span class="sx">%&gt;likes&lt;/span&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span><span class="p">(</span><span class="s2">&quot;#post_&lt;%= @post.id %&gt;_likes&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= @post.likes.size %&gt;likes&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Expansion</strong></p>

<p>We can also add a &lsquo;Unlike&rsquo; function with a &lsquo;Thumbs-down&rsquo; button.
Instead of <code>like: true</code> params, we set it to false. In order to show the total likes, we add a method called <code>total_likes</code> in post.rb.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">total_likes</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">like</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">self</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">like</span> <span class="ss">:false</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Notes: Adding categories]]></title>
    <link href="http://voice.lawrencesun.info/posts/2014/02/11/rails-notes-adding-categories/"/>
    <updated>2014-02-11T20:23:51+08:00</updated>
    <id>http://voice.lawrencesun.info/posts/2014/02/11/rails-notes-adding-categories</id>
    <content type="html"><![CDATA[<p>In the third note, a brief description about adding categories in a blog-like app will be presented. It is a <a href="http://guides.rubyonrails.org/association_basics.html">M-M relationship</a>. We will  apply <code>has_many :through</code> association.</p>

<!-- more -->


<p><strong>Migration</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreatePostCategories</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:post_categories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:post_id</span><span class="p">,</span> <span class="ss">:category_id</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>      <span class="n">drop_table</span> <span class="ss">:post_categories</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>PostCategories will have two foreign keys: :post_id and :category_id</p>

<p><strong>Models</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PostCategory</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:post</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:category</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Category</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:post_categories</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:post_categories</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:post_categories</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:post_categories</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Controller and routes</strong></p>

<p>similar to other resources.</p>

<p><strong>Views</strong></p>

<p>&lsquo;shared/_posts.html.erb&rsquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% object.reverse.each </span><span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx"> &lt;p&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;badge pull-right&quot;</span><span class="o">&gt;&lt;</span><span class="sx">%= post.comments.count %&gt;&lt;/span&gt;</span>
</span><span class='line'><span class="sx">     &lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="sx">%&gt;&lt;br&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="sx">% post.categories.each </span><span class="k">do</span> <span class="o">|</span><span class="n">category</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">     &lt;%= link_to category.name, category_path(category), class: &quot;label&quot; %&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
</span><span class='line'><span class="sx">   &lt;span class=&quot;timestamp&quot;&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="n">small</span><span class="o">&gt;</span><span class="n">posted</span> <span class="n">by</span> <span class="o">&lt;</span><span class="sx">% unless </span><span class="n">post</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">blank?</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">             &lt;%= link_to post.user.username, user_path(post.user) %&gt;</span>
</span><span class='line'>              <span class="o">&lt;</span><span class="sx">% end %&gt;</span>
</span><span class='line'><span class="sx">             &lt;%= time_ago_in_words(post.created_at)%&gt;</span> <span class="n">ago</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="sr">/small&gt;</span>
</span><span class='line'><span class="sr">     &lt;/s</span><span class="n">pan</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="n">hr</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'><span class="sr">&lt;% end %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>&lsquo;app/views/categories/show.html.erb&rsquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="o">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/posts&#39;</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="vi">@category</span><span class="o">.</span><span class="n">posts</span> <span class="o">%&gt;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add categories selection in _form partial</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s1">&#39;control-group&#39;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">%= f.label &quot;选择节点&quot; %&gt;</span>
</span><span class='line'><span class="sx">  &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">select</span> <span class="ss">:category_ids</span><span class="p">,</span> <span class="no">Category</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="o">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">]</span><span class="p">},</span> <span class="p">{},</span> <span class="p">{</span><span class="ss">multiple</span><span class="p">:</span> <span class="kp">false</span><span class="p">}</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add get_categories method in ApplicationController to show categories in header.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">get_categories</span>
</span><span class='line'>  <span class="vi">@categories</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">before_action</span> <span class="ss">:get_categories</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% @categories.each </span><span class="k">do</span> <span class="o">|</span><span class="n">cat</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;li&gt;</span><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="n">cat</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">category_path</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span> <span class="sx">%&gt;&lt;/li&gt;</span>  
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
